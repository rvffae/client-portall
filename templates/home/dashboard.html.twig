{% extends 'base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="dashboard-container">
    <!-- Header du Dashboard -->
    <header class="dashboard-header">
        <div class="dashboard-header-content">
            <div class="dashboard-welcome">
                <h1 class="dashboard-title">Dashboard</h1>
                <p class="dashboard-subtitle">Bienvenue {{ app.user ? app.user.userIdentifier : 'Utilisateur' }}</p>
            </div>
            <div class="dashboard-user-actions">
                <div class="dashboard-user-info">
                    <span class="dashboard-user-avatar">
                        {{ app.user ? app.user.userIdentifier|slice(0, 2)|upper : 'US' }}
                    </span>
                    <span class="dashboard-user-name">{{ app.user ? app.user.userIdentifier : 'Utilisateur' }}</span>
                </div>
                <a href="{{ path('app_logout') }}" class="dashboard-logout-btn">D√©connexion</a>
            </div>
        </div>
    </header>

    <!-- Navigation principale -->
    <nav class="dashboard-sidebar">
        <div class="dashboard-nav-header">
            <h2 class="dashboard-nav-title">Menu</h2>
        </div>
        <ul class="dashboard-nav-menu">
            <li class="dashboard-nav-item dashboard-nav-item-active">
                <a href="{{ path('dashboard')}}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:chart-pie') }}</span>
                    <span class="dashboard-nav-text">Tableau de bord</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="{{ path('communication_index') }}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:envelope') }}</span>
                    <span class="dashboard-nav-text">Messagerie</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="{{ path('app_invoice_index')}}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:invoice') }}</span>
                    <span class="dashboard-nav-text">Factures</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="{{path('app_client_index')}}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:users') }}</span>
                    <span class="dashboard-nav-text">Clients</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="{{path('app_company_index')}}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:buildings') }}</span>
                    <span class="dashboard-nav-text">Entreprises</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="{{path('app_project_index')}}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:folder') }}</span>
                    <span class="dashboard-nav-text">Projets</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="{{ path('app_invoice_stats')}}" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:chart-line') }}</span>
                    <span class="dashboard-nav-text">Statistiques</span>
                </a>
            </li>
            <li class="dashboard-nav-item">
                <a href="#" class="dashboard-nav-link">
                    <span class="dashboard-nav-icon">{{ ux_icon('ph:gear') }}</span>
                    <span class="dashboard-nav-text">Param√®tres</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Contenu principal -->
    <main class="dashboard-main">
        <!-- Cartes de statistiques -->
        <div class="dashboard-stats-grid">
            <div class="dashboard-stat-card dashboard-stat-card-primary">
                <div class="dashboard-stat-icon">üë•</div>
                <div class="dashboard-stat-content">
                    <h3 class="dashboard-stat-title">Clients</h3>
                    <p class="dashboard-stat-number">56</p>
                    <span class="dashboard-stat-change dashboard-stat-positive">+12%</span>
                </div>
            </div>

            <div class="dashboard-stat-card dashboard-stat-card-success">
                <div class="dashboard-stat-icon">üí∞</div>
                <div class="dashboard-stat-content">
                    <h3 class="dashboard-stat-title">Revenus</h3>
                    <p class="dashboard-stat-number">‚Ç¨45,678</p>
                    <span class="dashboard-stat-change dashboard-stat-positive">+8%</span>
                </div>
            </div>

            <div class="dashboard-stat-card dashboard-stat-card-warning">
                <div class="dashboard-stat-icon">üì¶</div>
                <div class="dashboard-stat-content">
                    <h3 class="dashboard-stat-title">Commandes</h3>
                    <p class="dashboard-stat-number">567</p>
                    <span class="dashboard-stat-change dashboard-stat-negative">-3%</span>
                </div>
            </div>

            <div class="dashboard-stat-card dashboard-stat-card-info">
                <div class="dashboard-stat-icon">üìä</div>
                <div class="dashboard-stat-content">
                    <h3 class="dashboard-stat-title">Taux de conversion</h3>
                    <p class="dashboard-stat-number">3.2%</p>
                    <span class="dashboard-stat-change dashboard-stat-positive">+0.5%</span>
                </div>
            </div>
        </div>

        <!-- Section Google Calendar -->
        <section class="dashboard-calendar-section">
            <div class="dashboard-widget dashboard-widget-full">
                <div class="dashboard-widget-header">
                    <h3 class="dashboard-widget-title">üìÖ Google Calendar</h3>
                    {% if isCalendarConnected %}
                        <div class="dashboard-calendar-actions">
                            <button type="button" class="dashboard-btn dashboard-btn-primary" onclick="openAddEventModal()">
                                ‚ûï Ajouter un √©v√©nement
                            </button>
                            <a href="{{ path('google_calendar_disconnect') }}" class="dashboard-btn dashboard-btn-secondary"
                               onclick="return confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')">
                                üîå D√©connecter
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="dashboard-widget-content">
                    {% if isCalendarConnected %}
                        <div class="dashboard-calendar-status dashboard-calendar-connected">
                            ‚úÖ Connect√© √† Google Calendar
                        </div>
                        <div class="dashboard-calendar-grid">
                            <!-- √âv√©nements d'aujourd'hui -->
                            <div class="dashboard-calendar-today">
                                <h4 class="dashboard-calendar-subtitle">üóìÔ∏è Aujourd'hui</h4>
                                {% if todayEvents|length > 0 %}
                                    <div class="dashboard-calendar-events">
                                        {% for event in todayEvents %}
                                            <div class="dashboard-calendar-event">
                                                <div class="dashboard-calendar-event-content">
                                                    <div class="dashboard-calendar-event-title">{{ event.title }}</div>
                                                    {% if not event.isAllDay %}
                                                        <div class="dashboard-calendar-event-time">‚è∞ {{ event.start|date('H:i') }}</div>
                                                    {% else %}
                                                        <div class="dashboard-calendar-event-time">üìÖ Toute la journ√©e</div>
                                                    {% endif %}
                                                    {% if event.location %}
                                                        <div class="dashboard-calendar-event-location">üìç {{ event.location }}</div>
                                                    {% endif %}
                                                </div>
                                                <button class="dashboard-calendar-delete-btn" onclick="deleteEvent('{{ event.id }}')" title="Supprimer">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="dashboard-calendar-empty">
                                        <div class="dashboard-calendar-empty-icon">üìÖ</div>
                                        <p>Aucun √©v√©nement aujourd'hui</p>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Prochains √©v√©nements -->
                            <div class="dashboard-calendar-upcoming">
                                <h4 class="dashboard-calendar-subtitle">üìÜ Prochains √©v√©nements</h4>
                                {% if upcomingEvents|length > 0 %}
                                    <div class="dashboard-calendar-events">
                                        {% for event in upcomingEvents %}
                                            <div class="dashboard-calendar-event">
                                                <div class="dashboard-calendar-event-content">
                                                    <div class="dashboard-calendar-event-title">{{ event.title }}</div>
                                                    <div class="dashboard-calendar-event-time">
                                                        üìÖ {{ event.start|date('d/m/Y') }}
                                                        {% if not event.isAllDay %}
                                                            √† {{ event.start|date('H:i') }}
                                                        {% endif %}
                                                    </div>
                                                    {% if event.location %}
                                                        <div class="dashboard-calendar-event-location">üìç {{ event.location }}</div>
                                                    {% endif %}
                                                </div>
                                                <button class="dashboard-calendar-delete-btn" onclick="deleteEvent('{{ event.id }}')" title="Supprimer">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="dashboard-calendar-empty">
                                        <div class="dashboard-calendar-empty-icon">üìÜ</div>
                                        <p>Aucun √©v√©nement √† venir</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="dashboard-calendar-disconnected">
                            <div class="dashboard-calendar-empty-icon">üìÖ</div>
                            <h4>Non connect√© √† Google Calendar</h4>
                            <p>Connectez votre compte Google pour voir et g√©rer vos √©v√©nements</p>
                            <a href="{{ path('google_calendar_auth') }}" class="dashboard-btn dashboard-btn-primary dashboard-btn-large">
                                Connecter Google Calendar
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Section des graphiques et tableaux -->
        <div class="dashboard-content-grid">
            <!-- Graphique principal -->
            <div class="dashboard-widget dashboard-widget-large">
           <!-- Graphiques -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">√âvolution Mensuelle du Chiffre d'Affaires</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="revenueChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des derni√®res activit√©s -->
            <div class="dashboard-widget">
                <div class="dashboard-widget-header">
                    <h3 class="dashboard-widget-title">Activit√©s r√©centes</h3>
                    <a href="#" class="dashboard-widget-link">Voir tout</a>
                </div>
                <div class="dashboard-widget-content">
                    <div class="dashboard-activity-list">
                        <div class="dashboard-activity-item">
                            <div class="dashboard-activity-avatar">üë§</div>
                            <div class="dashboard-activity-content">
                                <p class="dashboard-activity-text">Nouvel utilisateur inscrit</p>
                                <span class="dashboard-activity-time">Il y a 2 minutes</span>
                            </div>
                        </div>
                        <div class="dashboard-activity-item">
                            <div class="dashboard-activity-avatar">üí≥</div>
                            <div class="dashboard-activity-content">
                                <p class="dashboard-activity-text">Paiement re√ßu - ‚Ç¨149.99</p>
                                <span class="dashboard-activity-time">Il y a 15 minutes</span>
                            </div>
                        </div>
                        <div class="dashboard-activity-item">
                            <div class="dashboard-activity-avatar">üì¶</div>
                            <div class="dashboard-activity-content">
                                <p class="dashboard-activity-text">Commande #1234 exp√©di√©e</p>
                                <span class="dashboard-activity-time">Il y a 1 heure</span>
                            </div>
                        </div>
                        <div class="dashboard-activity-item">
                            <div class="dashboard-activity-avatar">‚ö†Ô∏è</div>
                            <div class="dashboard-activity-content">
                                <p class="dashboard-activity-text">Stock faible - Produit ABC</p>
                                <span class="dashboard-activity-time">Il y a 2 heures</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="dashboard-widget">
                <div class="dashboard-widget-header">
                    <h3 class="dashboard-widget-title">Actions rapides</h3>
                </div>
                <div class="dashboard-widget-content">
                    <div class="dashboard-quick-actions">
                        <button class="dashboard-quick-action">
                            <span class="dashboard-quick-action-icon">‚ûï</span>
                            <span class="dashboard-quick-action-text">Ajouter un utilisateur</span>
                        </button>
                        <button class="dashboard-quick-action">
                            <span class="dashboard-quick-action-icon">üìä</span>
                            <span class="dashboard-quick-action-text">G√©n√©rer un rapport</span>
                        </button>
                        <button class="dashboard-quick-action">
                            <span class="dashboard-quick-action-icon">üíå</span>
                            <span class="dashboard-quick-action-text">Envoyer une newsletter</span>
                        </button>
                        <button class="dashboard-quick-action">
                            <span class="dashboard-quick-action-icon">‚öôÔ∏è</span>
                            <span class="dashboard-quick-action-text">Configuration</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="dashboard-widget">
                <div class="dashboard-widget-header">
                    <h3 class="dashboard-widget-title">Notifications</h3>
                    <span class="dashboard-notification-badge">3</span>
                </div>
                <div class="dashboard-widget-content">
                    <div class="dashboard-notifications">
                        <div class="dashboard-notification dashboard-notification-success">
                            <div class="dashboard-notification-icon">‚úÖ</div>
                            <div class="dashboard-notification-content">
                                <p class="dashboard-notification-title">Sauvegarde termin√©e</p>
                                <span class="dashboard-notification-time">Il y a 5 minutes</span>
                            </div>
                        </div>
                        <div class="dashboard-notification dashboard-notification-warning">
                            <div class="dashboard-notification-icon">‚ö†Ô∏è</div>
                            <div class="dashboard-notification-content">
                                <p class="dashboard-notification-title">Mise √† jour disponible</p>
                                <span class="dashboard-notification-time">Il y a 1 heure</span>
                            </div>
                        </div>
                        <div class="dashboard-notification dashboard-notification-info">
                            <div class="dashboard-notification-icon">‚ÑπÔ∏è</div>
                            <div class="dashboard-notification-content">
                                <p class="dashboard-notification-title">Maintenance programm√©e</p>
                                <span class="dashboard-notification-time">Demain 02:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal d'ajout d'√©v√©nement -->
        {% if isCalendarConnected %}
        <div class="dashboard-modal" id="addEventModal">
            <div class="dashboard-modal-content">
                <div class="dashboard-modal-header">
                    <h3>‚ûï Ajouter un √©v√©nement</h3>
                    <button class="dashboard-modal-close" onclick="closeAddEventModal()">&times;</button>
                </div>
                <form id="addEventForm" onsubmit="addEvent(event)">
                    <div class="dashboard-modal-body">
                        <div class="dashboard-form-group">
                            <label for="eventTitle">Titre *</label>
                            <input type="text" id="eventTitle" name="title" required>
                        </div>
                        <div class="dashboard-form-group">
                            <label for="eventDescription">Description</label>
                            <textarea id="eventDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="dashboard-form-row">
                            <div class="dashboard-form-group">
                                <label for="eventStartDate">Date de d√©but *</label>
                                <input type="date" id="eventStartDate" name="start_date" required>
                            </div>
                            <div class="dashboard-form-group">
                                <label for="eventStartTime">Heure de d√©but</label>
                                <input type="time" id="eventStartTime" name="start_time">
                            </div>
                        </div>
                        <div class="dashboard-form-row">
                            <div class="dashboard-form-group">
                                <label for="eventEndDate">Date de fin</label>
                                <input type="date" id="eventEndDate" name="end_date">
                            </div>
                            <div class="dashboard-form-group">
                                <label for="eventEndTime">Heure de fin</label>
                                <input type="time" id="eventEndTime" name="end_time">
                            </div>
                        </div>
                        <div class="dashboard-form-group">
                            <label for="eventLocation">Lieu</label>
                            <input type="text" id="eventLocation" name="location" placeholder="Adresse ou lieu">
                        </div>
                        <div class="dashboard-checkbox-group">
                            <input type="checkbox" id="allDayEvent" name="all_day">
                            <label for="allDayEvent">√âv√©nement toute la journ√©e</label>
                        </div>
                    </div>
                    <div class="dashboard-modal-footer">
                        <button type="button" class="dashboard-btn dashboard-btn-secondary" onclick="closeAddEventModal()">Annuler</button>
                        <button type="submit" class="dashboard-btn dashboard-btn-primary">Cr√©er l'√©v√©nement</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration des couleurs
    const colors = {
        primary: '#007bff',
        success: '#9f8290',
        info: '#17a2b8',
        warning: '#ffc107',
        danger: '#dc3545'
    };

    // Fonction pour formater les montants
    function formatMoney(amount) {
        return new Intl.NumberFormat('fr-FR', {
            style: 'currency',
            currency: 'EUR'
        }).format(amount);
    }

    // Charger les donn√©es du chiffre d'affaires mensuel
    fetch('{{ path("app_invoice_revenue_data") }}')
        .then(response => response.json())
        .then(data => {
            console.log('Donn√©es re√ßues:', data);
            
            // V√©rifier si on a des donn√©es
            if (!data.labels || !data.data || data.data.length === 0) {
                console.error('Aucune donn√©e disponible');
                return;
            }
            
            // Graphique lin√©aire mensuel
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Chiffre d\'Affaires (‚Ç¨)',
                        data: data.data,
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // Calculer et afficher les statistiques
            const totalRevenue = data.data.reduce((sum, amount) => sum + amount, 0);
            const avgAmount = totalRevenue / data.data.length;
            
            document.getElementById('total-revenue').textContent = formatMoney(totalRevenue);
            document.getElementById('avg-amount').textContent = formatMoney(avgAmount);
            document.getElementById('total-invoices').textContent = data.data.length + ' mois';
        })
        .catch(error => {
            console.error('Erreur lors du chargement des donn√©es:', error);
        });

    // Graphique en barres pour les ann√©es (donn√©es r√©elles)
    fetch('{{ path("app_invoice_yearly_revenue_data") }}')
        .then(response => response.json())
        .then(yearlyData => {
            console.log('Donn√©es annuelles re√ßues:', yearlyData);
            
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            new Chart(yearlyCtx, {
                type: 'doughnut',
                data: {
                    labels: yearlyData.labels || ['2024'],
                    datasets: [{
                        data: yearlyData.data || [50000],
                        backgroundColor: yearlyData.backgroundColor || [colors.primary, colors.success, colors.info],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatMoney(context.parsed);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des donn√©es annuelles:', error);
            // Graphique de fallback
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            new Chart(yearlyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['2024'],
                    datasets: [{
                        data: [50000],
                        backgroundColor: [colors.primary],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                }
            });
        });
});
</script>
{% endblock %}

